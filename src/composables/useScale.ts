export type Gender = 'male' | 'female'

interface Criterion {
  id: number
  name: string
  description: string
}

const criteriaFemale: Criterion[] = [
  { id: 1, name: 'Верность и надёжность (физическая и эмоциональная)', description: 'Не изменяет, не держит бывших «про запас», не строит тайных эмоциональных связей. Держит слово и обязательства в паре.' },
  { id: 2, name: 'Стабильность и адекватность', description: 'Без непредсказуемых срывов, агрессии и «молчанок». Решает разговором, а не давлением или уходом в себя.' },
  { id: 3, name: 'Быт и хозяйственность как соучастие', description: 'Ремонт, техника, инициатива по дому и бюджету — не «помощник», а полноценный, ответственный участник общей жизни.' },
  { id: 4, name: 'Воспитанность и уважительная подача', description: 'Без хвастовства, пошлости и демонстративной «крутости». Уважение к людям и к партнёрше — и на людях, и наедине.' },
  { id: 5, name: 'Эмоциональный интеллект и диалог', description: 'Умеет слушать, признавать ошибки и договариваться. Способен распознавать и называть свои эмоции и учитывать эмоции партнёрши в диалоге.' },
  { id: 6, name: 'Внешность, осанка и адекватная самооценка', description: 'Ухоженность, физическая форма, стиль — без перекосов в нарциссизм или полное пренебрежение.' },
  { id: 7, name: 'Секс и близость как взаимный процесс', description: 'Внимание к желаниям партнёрши, отсутствие давления и «долга». Совпадение темпераментов и готовность к диалогу об intimacy.' },
  { id: 8, name: 'Уважение к женщине как к равной личности', description: 'Считается с мнением и чувствами, не обесценивает. В споре атакует проблему, а не личность, не использует уязвимости как аргумент.' },
  { id: 9, name: 'Совместные цели и разделённая ответственность', description: 'Имеет согласованные с партнёршей цели по семье, детям, деньгам. Готов нести ответственность и гибко корректировать планы.' },
  { id: 10, name: 'Конструктивное разрешение конфликтов', description: 'Способен первым пойти на примирение и диалог. Не застревает в обиде, не эскалирует ссору, ищет решение.' },
  { id: 11, name: 'Личная устойчивость и взрослая позиция', description: 'Имеет собственные здоровые способы справляться со стрессом (хобби, спорт), не сваливает всю эмоциональную нагрузку на партнёршу. Видит в отношениях союз двух целых личностей, а не поиск «спасателя» или «мамы».' }
]

const criteriaMale: Criterion[] = [
  { id: 1, name: 'Верность и порядочность', description: 'Отношение к изменам, наличие бывших в активном доступе, порядочность в отношениях.' },
  { id: 2, name: 'Эмоциональная стабильность и прямота', description: 'Способна открыто заявлять о своих потребностях и обидах, а не копить их для последующего «взрыва». Без эмоциональных качелей и манипуляций.' },
  { id: 3, name: 'Участие в быту и создание уюта', description: 'Видит в домашних заботах общую задачу пары, а не «обслуживание» мужчины. Проявляет инициативу, комфорт, чистота, еда.' },
  { id: 4, name: 'Скромность и воспитание', description: 'Уважение к социальным нормам и личным границам партнёра. Проявляет достоинство, а не высокомерие. Отсутствие вульгарности.' },
  { id: 5, name: 'Интеллект и гибкость ума', description: 'Способность слышать аргументы, признавать ошибки, вести содержательный диалог.' },
  { id: 6, name: 'Внешность и женственность', description: 'Натуральная красота, уход за собой, мягкость движений, голос, стиль одежды.' },
  { id: 7, name: 'Сексуальная совместимость', description: 'Отсутствие «торговли» сексом, совпадение темпераментов, готовность радовать партнёра.' },
  { id: 8, name: 'Уважение к роли партнёра и доверие', description: 'Признаёт зоны ответственности и компетенции партнёра. Критикует по существу, предлагая решения, а не подрывает авторитет в принципе. Верит в его успех.' },
  { id: 9, name: 'Жизненные ценности и цели', description: 'Совпадение взглядов на семью, детей, деньги, развитие; отсутствие чистого потребительства.' },
  { id: 10, name: 'Конструктивное поведение в конфликте', description: 'Способна первой инициировать перемирие, сохраняя суть претензий, но меняя тон. Не использует молчание как оружие.' },
  { id: 11, name: 'Самоценность и взаимная поддержка', description: 'Видит в отношениях союз двух целых личностей. Имеет собственные опоры, не ищет в партнёре «папу» или спасателя. Поддерживает и принимает поддержку.' }
]

export function getCriteria(gender: Gender): Criterion[] {
  return gender === 'female' ? criteriaFemale : criteriaMale
}

export interface FormQuestion {
  text: string
  options: [string, string, string]
}

const formQuestionsFemale: FormQuestion[] = [
  { text: 'Моё нахождение в этих отношениях — это осознанный ежедневный выбор или привычка и рутина?', options: ['Выбор', 'Не знаю', 'Привычка'] },
  { text: 'Вижу ли я этого человека отцом своих будущих детей (в перспективе)?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Если представить, что он не изменится ни на грамм, я всё равно хочу быть с ним до конца жизни?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Что я чувствую рядом с ним чаще всего?', options: ['Спокойствие и безопасность', 'Затрудняюсь ответить', 'Напряжение и тревогу'] },
  { text: 'В наших отношениях я чувствую поддержку и плечо рядом или мне приходится «тащить всё на себе»?', options: ['Поддержку', 'Не знаю', 'Тащу на себе'] },
  { text: 'Могу ли я быть рядом с ним полностью собой, не играя роли?', options: ['Да', 'Частично', 'Нет'] },
  { text: 'Расту ли я как личность в этих отношениях (развиваюсь, узнаю новое, становлюсь лучше)?', options: ['Да', 'Отношения не влияют на рост', 'Нет, я деградирую или стою на месте'] },
  { text: 'Если бы у меня была дочь, желала бы я для неё таких же отношений с таким партнёром?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Уважаю ли я этого человека (его ум, поступки, жизненную позицию)?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Поддерживает ли он мои цели и мечты, радуется ли моим успехам?', options: ['Да', 'Иногда', 'Нет'] },
  { text: 'Если бы завтра исчезли все внешние обстоятельства (страх одиночества, общий быт, мнение окружающих), выбрала бы я его снова?', options: ['Да, однозначно', 'Не знаю', 'Нет'] }
]

const formQuestionsMale: FormQuestion[] = [
  { text: 'Моё нахождение в этих отношениях — это осознанный ежедневный выбор или привычка и рутина?', options: ['Выбор', 'Не знаю', 'Привычка'] },
  { text: 'Вижу ли я эту женщину матерью своих будущих детей (в перспективе)?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Если представить, что она не изменится ни на грамм, я всё равно хочу быть с ней до конца жизни?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Что я чувствую рядом с ней чаще всего?', options: ['Ресурс и спокойствие', 'Затрудняюсь ответить', 'Напряжение и тревогу'] },
  { text: 'В наших отношениях я чувствую поддержку и плечо рядом или мне приходится «тащить всё на себе»?', options: ['Поддержку', 'Не знаю', 'Тащу на себе'] },
  { text: 'Могу ли я быть рядом с ней полностью собой, не играя роли?', options: ['Да', 'Частично', 'Нет'] },
  { text: 'Расту ли я как личность в этих отношениях (развиваюсь, узнаю новое, становлюсь лучше)?', options: ['Да', 'Отношения не влияют на рост', 'Нет, деградирую или стою на месте'] },
  { text: 'Если бы у меня был сын, желал бы я для него таких же отношений с такой партнёршей?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Уважаю ли я эту женщину (её ум, поступки, жизненную позицию)?', options: ['Да', 'Не знаю', 'Нет'] },
  { text: 'Поддерживает ли она мои цели и мечты, радуется ли моим успехам?', options: ['Да', 'Иногда', 'Нет'] },
  { text: 'Если бы завтра исчезли все внешние обстоятельства (страх одиночества, общий быт, мнение окружающих), выбрал бы я её снова?', options: ['Да, однозначно', 'Не знаю', 'Нет'] }
]

export function getFormQuestions(gender: Gender): FormQuestion[] {
  return gender === 'female' ? formQuestionsFemale : formQuestionsMale
}

export interface AnalysisResult {
  total: number
  category: string
  categoryClass: string
  description: string
  penalty: string | null
  redFlags: string[]
  isGoldenStandard: boolean
}

const categoriesFemale = [
  { min: 90, name: 'Единорог', class: 'unicorn', desc: 'Идеал. Береги как зеницу ока, инвестируй максимум.' },
  { min: 80, name: 'Высшая лига', class: 'top', desc: 'Отличный вариант. Стоит строить серьёзные отношения.' },
  { min: 70, name: 'Золотая середина', class: 'gold', desc: 'Хороший баланс. Можно развивать при взаимных усилиях.' },
  { min: 60, name: 'Рабочий вариант', class: 'work', desc: 'Есть над чем работать, но потенциал присутствует.' },
  { min: 51, name: 'Зона риска', class: 'risk', desc: 'Много проблемных зон. Подумай дважды.' },
  { min: 0, name: 'Непригоден', class: 'unfit', desc: 'Режим дистанции. Чёрная дыра для нервов, времени и денег. Переделать/спасти нельзя — дефолт. Полный игнор или разовый секс (если безопасно), без общей территории и планов.' }
]
const categoriesMale = [
  { min: 90, name: 'Единорог', class: 'unicorn', desc: 'Идеал. Береги как зеницу ока, инвестируй максимум.' },
  { min: 80, name: 'Высшая лига', class: 'top', desc: 'Отличный вариант. Стоит строить серьёзные отношения.' },
  { min: 70, name: 'Золотая середина', class: 'gold', desc: 'Хороший баланс. Можно развивать при взаимных усилиях.' },
  { min: 60, name: 'Рабочий вариант', class: 'work', desc: 'Есть над чем работать, но потенциал присутствует.' },
  { min: 51, name: 'Зона риска', class: 'risk', desc: 'Много проблемных зон. Подумай дважды.' },
  { min: 0, name: 'Непригодна', class: 'unfit', desc: 'Режим дистанции. Чёрная дыра для нервов, времени и денег. Переделать/спасти нельзя — дефолт. Полный игнор или разовый секс (если безопасно), без общей территории и планов.' }
]

export function analyzeScores(scores: number[], gender: Gender): AnalysisResult {
  const criteriaList = getCriteria(gender)
  const usedScores = scores.slice(0, criteriaList.length)
  const total = usedScores.reduce((sum, s) => sum + s, 0)
  const redFlags: string[] = []
  const categories = gender === 'male' ? categoriesMale : categoriesFemale
  const unfitLabel = gender === 'male' ? 'Непригодна' : 'Непригоден'

  const labelP3 = gender === 'male' ? 'Быту и соучастию (п.3)' : 'Участию в быту (п.3)'
  const isPenalized = (scores[0] ?? 0) < 4 || (scores[2] ?? 0) < 4
  const penalty = isPenalized
    ? `Применён штраф: по Верности (п.1) или ${labelP3} < 4 → итог «${unfitLabel}».`
    : null

  if ((scores[0] ?? 0) <= 3) redFlags.push('1')
  if ((scores[7] ?? 0) <= 3) redFlags.push('8')

  const isGoldenStandard = total >= 75 && usedScores.every(s => s >= 6)

  let cat = categories[categories.length - 1]
  if (!isPenalized) {
    for (const c of categories) {
      if (total >= c.min) {
        cat = c
        break
      }
    }
  }

  return {
    total,
    category: cat.name,
    categoryClass: cat.class,
    description: cat.desc,
    penalty,
    redFlags,
    isGoldenStandard
  }
}

export function buildPrompt(scores: number[], analysis: AnalysisResult, gender: Gender): string {
  const criteriaList = getCriteria(gender)
  const scoresList = criteriaList.map((c, i) => `${c.name}: ${scores[i]}/10`).join('\n')
  const subject = gender === 'male' ? 'мужчина' : 'женщина'

  return `Анализ партнёра по шкале оценки отношений (Cold Format).
Оцениваем: ${subject}


Оценки (0-10):
${scoresList}

Итого: ${analysis.total}/${criteriaList.length * 10}
Категория: ${analysis.category}
${analysis.penalty ? `\n${analysis.penalty}` : ''}
${analysis.redFlags.length ? `Красные флаги: низкие баллы по пунктам ${analysis.redFlags.join(', ')} (≤3)` : ''}
${analysis.isGoldenStandard ? 'Соответствует золотому стандарту (75+ и все пункты ≥6)!' : ''}

Дай краткий анализ (3-4 абзаца):
1. Общая оценка ситуации
2. Ключевые сильные стороны
3. Зоны риска и на что обратить внимание
4. Рекомендации по стратегии отношений`
}
